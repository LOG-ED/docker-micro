version: '2'

services:
    registry:
        command: -server -bootstrap -rejoin #-advertise=$DOCKER_IP
        image: progrium/consul:latest
        ports:
            - "8300:8300"
            - "8400:8400"
            - "8500:8500"
            - "8600:53/udp"
    srv:
        build: .
        image: docker-micro
        command: --registry_address=registry:8500
        depends_on:
            - registry

    web:
        image: microhq/micro:latest
        command: --registry_address=registry:8500 web
        ports:
            - "80:8082"

    client:
        build:
            context: .
            dockerfile: Dockerfile.client
        command: --task_endpoint=srv:40521
        depends_on:
            - srv